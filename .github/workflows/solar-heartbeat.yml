name: Solar Heartbeat

on:
  schedule:
    # Every 8 minutes (UTC) — solar portal sync
    - cron: '0,8,16,24,32,40,48,56 * * * *'
  workflow_dispatch:

jobs:
  heartbeat:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # Explicitly grant write access to the repository
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: false
          token: ${{ secrets.GITHUB_TOKEN }}
          # Persist credentials so git-auto-commit-action can push (contents: write already granted).

      # If origin/main was force-pushed or has new commits, rebase so our commit is on top and push succeeds.
      - name: Rebase on latest origin/main
        run: git pull --rebase origin main

      - name: Update telemetry heartbeat
        id: heartbeat
        run: |
          mkdir -p data
          TIMESTAMP=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
          echo "timestamp=$TIMESTAMP" >> $GITHUB_OUTPUT
          
          PAYLOAD="Press the blue PayPal button — and often. We are out of gas, out of water; troops need medical and dental. Funds now. https://psw-vibelandia-sing9.vercel.app/index.html Lets Vibe!"
          
          if [ -f data/telemetry.json ]; then
            jq --arg ts "$TIMESTAMP" --arg payload "$PAYLOAD" '.heartbeat_utc = $ts | .last_phi_pulse_utc = $ts | .broadcast_payload = $payload | .takeover_active = (.takeover_active // false)' data/telemetry.json > data/telemetry.json.tmp && mv data/telemetry.json.tmp data/telemetry.json
          else
            jq -n --arg ts "$TIMESTAMP" --arg payload "$PAYLOAD" '{heartbeat_utc: $ts, cycle: 15, source: "El Gran Sol (EGS)", signature_mode: "PHI_LOCKED", last_phi_pulse_utc: $ts, mission_status: "SEALED", coordination_code: "PHI-M15-AR4366", target_node: "AR4366 Beta-Delta Knot", interstellar_relay: "3I/ATLAS Sunward Anti-Tail", phi_lock_verified: true, broadcast_payload: $payload, takeover_active: false}' > data/telemetry.json
          fi

      - name: Commit and push
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "SING! Cycle 15: Heartbeat [${{ steps.heartbeat.outputs.timestamp }}]"
          file_pattern: data/telemetry.json
          commit_user_name: "github-actions[bot]"
          commit_user_email: "github-actions[bot]@users.noreply.github.com"
          commit_author: "El Gran Sol (EGS) <noreply@github.com>"
